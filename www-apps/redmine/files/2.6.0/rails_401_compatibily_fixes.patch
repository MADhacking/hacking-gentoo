From 675b5b0ff8cbd5d02cb867c044798dbb2e303c9f Mon Sep 17 00:00:00 2001
From: Toshi MARUYAMA <marutosijp2@yahoo.co.jp>
Date: Fri, 20 Dec 2013 07:10:46 +0000
Subject: [PATCH 01/18] Rails4: db migrate: replace
 "Permission.find_by_controller_and_action"

git-svn-id: http://svn.redmine.org/redmine/trunk@12422 e93f8b46-1217-0410-a6f0-8f06a7374b81
---
 db/migrate/018_set_doc_and_files_notifications.rb     | 16 ++++++++--------
 db/migrate/025_add_search_permission.rb               |  2 +-
 db/migrate/030_add_projects_feeds_permissions.rb      |  2 +-
 db/migrate/033_add_timelog_permissions.rb             |  2 +-
 db/migrate/043_add_relations_permissions.rb           |  4 ++--
 db/migrate/047_add_boards_permissions.rb              |  6 +++---
 db/migrate/049_add_wiki_destroy_page_permission.rb    |  2 +-
 db/migrate/050_add_wiki_attachments_permissions.rb    |  4 ++--
 db/migrate/056_add_repositories_changes_permission.rb |  2 +-
 9 files changed, 20 insertions(+), 20 deletions(-)

diff --git a/db/migrate/018_set_doc_and_files_notifications.rb b/db/migrate/018_set_doc_and_files_notifications.rb
index 8c1d054..f260beb 100644
--- a/db/migrate/018_set_doc_and_files_notifications.rb
+++ b/db/migrate/018_set_doc_and_files_notifications.rb
@@ -3,16 +3,16 @@ class SetDocAndFilesNotifications < ActiveRecord::Migration
   class Permission < ActiveRecord::Base; end
 
   def self.up
-    Permission.find_by_controller_and_action("projects", "add_file").update_attribute(:mail_option, true)
-    Permission.find_by_controller_and_action("projects", "add_document").update_attribute(:mail_option, true)
-    Permission.find_by_controller_and_action("documents", "add_attachment").update_attribute(:mail_option, true)
-    Permission.find_by_controller_and_action("issues", "add_attachment").update_attribute(:mail_option, true)
+    Permission.where(:controller => "projects", :action => "add_file").each {|p| p.update_attribute(:mail_option, true)}
+    Permission.where(:controller => "projects", :action => "add_document").each {|p| p.update_attribute(:mail_option, true)}
+    Permission.where(:controller => "documents", :action => "add_attachment").each {|p| p.update_attribute(:mail_option, true)}
+    Permission.where(:controller => "issues", :action => "add_attachment").each {|p| p.update_attribute(:mail_option, true)}
   end
 
   def self.down
-    Permission.find_by_controller_and_action("projects", "add_file").update_attribute(:mail_option, false)
-    Permission.find_by_controller_and_action("projects", "add_document").update_attribute(:mail_option, false)
-    Permission.find_by_controller_and_action("documents", "add_attachment").update_attribute(:mail_option, false)
-    Permission.find_by_controller_and_action("issues", "add_attachment").update_attribute(:mail_option, false)
+    Permission.where(:controller => "projects", :action => "add_file").each {|p| p.update_attribute(:mail_option, false)}
+    Permission.where(:controller => "projects", :action => "add_document").each {|p| p.update_attribute(:mail_option, false)}
+    Permission.where(:controller => "documents", :action => "add_attachment").each {|p| p.update_attribute(:mail_option, false)}
+    Permission.where(:controller => "issues", :action => "add_attachment").each {|p| p.update_attribute(:mail_option, false)}
   end
 end
diff --git a/db/migrate/025_add_search_permission.rb b/db/migrate/025_add_search_permission.rb
index a942b01..7f1c5c6 100644
--- a/db/migrate/025_add_search_permission.rb
+++ b/db/migrate/025_add_search_permission.rb
@@ -7,6 +7,6 @@ class AddSearchPermission < ActiveRecord::Migration
   end
 
   def self.down
-    Permission.find_by_controller_and_action('projects', 'search').destroy
+    Permission.where(:controller => "projects", :action => "search").each {|p| p.destroy}
   end
 end
diff --git a/db/migrate/030_add_projects_feeds_permissions.rb b/db/migrate/030_add_projects_feeds_permissions.rb
index 7f97035..866cc39 100644
--- a/db/migrate/030_add_projects_feeds_permissions.rb
+++ b/db/migrate/030_add_projects_feeds_permissions.rb
@@ -7,6 +7,6 @@ class AddProjectsFeedsPermissions < ActiveRecord::Migration
   end
 
   def self.down
-    Permission.find_by_controller_and_action('projects', 'feeds').destroy
+    Permission.where(:controller => "projects", :action => "feeds").each {|p| p.destroy}
   end
 end
diff --git a/db/migrate/033_add_timelog_permissions.rb b/db/migrate/033_add_timelog_permissions.rb
index ab9c809..58e2c43 100644
--- a/db/migrate/033_add_timelog_permissions.rb
+++ b/db/migrate/033_add_timelog_permissions.rb
@@ -7,6 +7,6 @@ class AddTimelogPermissions < ActiveRecord::Migration
   end
 
   def self.down
-    Permission.find_by_controller_and_action('timelog', 'edit').destroy
+    Permission.where(:controller => "timelog", :action => "edit").each {|p| p.destroy}
   end
 end
diff --git a/db/migrate/043_add_relations_permissions.rb b/db/migrate/043_add_relations_permissions.rb
index 32d464a..3c86d7e 100644
--- a/db/migrate/043_add_relations_permissions.rb
+++ b/db/migrate/043_add_relations_permissions.rb
@@ -8,7 +8,7 @@ class AddRelationsPermissions < ActiveRecord::Migration
   end
 
   def self.down
-    Permission.find_by_controller_and_action("issue_relations", "new").destroy
-    Permission.find_by_controller_and_action("issue_relations", "destroy").destroy
+    Permission.where(:controller => "issue_relations", :action => "new").each {|p| p.destroy}
+    Permission.where(:controller => "issue_relations", :action => "destroy").each {|p| p.destroy}
   end
 end
diff --git a/db/migrate/047_add_boards_permissions.rb b/db/migrate/047_add_boards_permissions.rb
index 5b1f6f7..1a9f095 100644
--- a/db/migrate/047_add_boards_permissions.rb
+++ b/db/migrate/047_add_boards_permissions.rb
@@ -9,8 +9,8 @@ class AddBoardsPermissions < ActiveRecord::Migration
   end
 
   def self.down
-    Permission.find_by_controller_and_action("boards", "new").destroy
-    Permission.find_by_controller_and_action("boards", "edit").destroy
-    Permission.find_by_controller_and_action("boards", "destroy").destroy
+    Permission.where(:controller => "boards", :action => "new").each {|p| p.destroy}
+    Permission.where(:controller => "boards", :action => "edit").each {|p| p.destroy}
+    Permission.where(:controller => "boards", :action => "destroy").each {|p| p.destroy}
   end
 end
diff --git a/db/migrate/049_add_wiki_destroy_page_permission.rb b/db/migrate/049_add_wiki_destroy_page_permission.rb
index c821523..803d357 100644
--- a/db/migrate/049_add_wiki_destroy_page_permission.rb
+++ b/db/migrate/049_add_wiki_destroy_page_permission.rb
@@ -7,6 +7,6 @@ class AddWikiDestroyPagePermission < ActiveRecord::Migration
   end
 
   def self.down
-    Permission.find_by_controller_and_action('wiki', 'destroy').destroy
+    Permission.where(:controller => "wiki", :action => "destroy").each {|p| p.destroy}
   end
 end
diff --git a/db/migrate/050_add_wiki_attachments_permissions.rb b/db/migrate/050_add_wiki_attachments_permissions.rb
index c0697be..e87a46b 100644
--- a/db/migrate/050_add_wiki_attachments_permissions.rb
+++ b/db/migrate/050_add_wiki_attachments_permissions.rb
@@ -8,7 +8,7 @@ class AddWikiAttachmentsPermissions < ActiveRecord::Migration
   end
 
   def self.down
-    Permission.find_by_controller_and_action('wiki', 'add_attachment').destroy
-    Permission.find_by_controller_and_action('wiki', 'destroy_attachment').destroy
+    Permission.where(:controller => "wiki", :action => "add_attachment").each {|p| p.destroy}
+    Permission.where(:controller => "wiki", :action => "destroy_attachment").each {|p| p.destroy}
   end
 end
diff --git a/db/migrate/056_add_repositories_changes_permission.rb b/db/migrate/056_add_repositories_changes_permission.rb
index 0d9b13b..00252db 100644
--- a/db/migrate/056_add_repositories_changes_permission.rb
+++ b/db/migrate/056_add_repositories_changes_permission.rb
@@ -7,6 +7,6 @@ class AddRepositoriesChangesPermission < ActiveRecord::Migration
   end
 
   def self.down
-    Permission.find_by_controller_and_action('repositories', 'changes').destroy
+    Permission.where(:controller => "repositories", :action => "changes").each {|p| p.destroy}
   end
 end
-- 
1.8.4.5

From 09cd99a6954bdc6f4894d4a3118e38cc5acbb65d Mon Sep 17 00:00:00 2001
From: Toshi MARUYAMA <marutosijp2@yahoo.co.jp>
Date: Fri, 20 Dec 2013 11:54:23 +0000
Subject: [PATCH 02/18] Rails4 compatibility of Setting model

git-svn-id: http://svn.redmine.org/redmine/trunk@12423 e93f8b46-1217-0410-a6f0-8f06a7374b81
---
 app/models/setting.rb | 5 +++--
 1 file changed, 3 insertions(+), 2 deletions(-)

diff --git a/app/models/setting.rb b/app/models/setting.rb
index 444f45e..993b43b 100644
--- a/app/models/setting.rb
+++ b/app/models/setting.rb
@@ -240,9 +240,10 @@ private
   def self.find_or_default(name)
     name = name.to_s
     raise "There's no setting named #{name}" unless @@available_settings.has_key?(name)
-    setting = find_by_name(name)
+    setting = where(:name => name).first
     unless setting
-      setting = new(:name => name)
+      setting = new
+      setting.name = name
       setting.value = @@available_settings[name]['default']
     end
     setting
-- 
1.8.4.5

From 2111450209ef07f09f6cdf0e7282a518997a345f Mon Sep 17 00:00:00 2001
From: Toshi MARUYAMA <marutosijp2@yahoo.co.jp>
Date: Sun, 22 Dec 2013 12:58:04 +0000
Subject: [PATCH 03/18] Rails4 compatibility of stylesheet_link_tag and
 javascript_include_tag at ApplicationHelper

git-svn-id: http://svn.redmine.org/redmine/trunk@12441 e93f8b46-1217-0410-a6f0-8f06a7374b81
---
 app/helpers/application_helper.rb | 4 ++--
 1 file changed, 2 insertions(+), 2 deletions(-)

diff --git a/app/helpers/application_helper.rb b/app/helpers/application_helper.rb
index c70a1f7..d65ffeb 100644
--- a/app/helpers/application_helper.rb
+++ b/app/helpers/application_helper.rb
@@ -1138,7 +1138,7 @@ module ApplicationHelper
         source
       end
     end
-    super sources, options
+    super *sources, options
   end
 
   # Overrides Rails' image_tag with themes and plugins support.
@@ -1171,7 +1171,7 @@ module ApplicationHelper
         end
       end
     end
-    super sources, options
+    super *sources, options
   end
 
   # TODO: remove this in 2.5.0
-- 
1.8.4.5

From 5fc4e37ec7029895329ec5a9b1a59e170c3307a5 Mon Sep 17 00:00:00 2001
From: Toshi MARUYAMA <marutosijp2@yahoo.co.jp>
Date: Tue, 24 Dec 2013 05:06:36 +0000
Subject: [PATCH 04/18] change requirement in bazaar lib as same with other scm
 libs (#15756)

git-svn-id: http://svn.redmine.org/redmine/trunk@12456 e93f8b46-1217-0410-a6f0-8f06a7374b81
---
 lib/redmine/scm/adapters/bazaar_adapter.rb | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/lib/redmine/scm/adapters/bazaar_adapter.rb b/lib/redmine/scm/adapters/bazaar_adapter.rb
index b0a0a89..8de831d 100644
--- a/lib/redmine/scm/adapters/bazaar_adapter.rb
+++ b/lib/redmine/scm/adapters/bazaar_adapter.rb
@@ -15,7 +15,7 @@
 # along with this program; if not, write to the Free Software
 # Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.
 
-require 'redmine/scm/adapters'
+require 'redmine/scm/adapters/abstract_adapter'
 
 module Redmine
   module Scm
-- 
1.8.4.5

From 37e9b3fa6382d96ab58131c95980295b44d07385 Mon Sep 17 00:00:00 2001
From: Toshi MARUYAMA <marutosijp2@yahoo.co.jp>
Date: Thu, 26 Dec 2013 03:18:57 +0000
Subject: [PATCH 05/18] fix Pagination helper test class name

git-svn-id: http://svn.redmine.org/redmine/trunk@12460 e93f8b46-1217-0410-a6f0-8f06a7374b81
---
 test/unit/lib/redmine/pagination_helper_test.rb | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/test/unit/lib/redmine/pagination_helper_test.rb b/test/unit/lib/redmine/pagination_helper_test.rb
index 1134b06..13c066f 100644
--- a/test/unit/lib/redmine/pagination_helper_test.rb
+++ b/test/unit/lib/redmine/pagination_helper_test.rb
@@ -17,7 +17,7 @@
 
 require File.expand_path('../../../../test_helper', __FILE__)
 
-class ApplicationHelperTest < ActionView::TestCase
+class PaginationHelperTest < ActionView::TestCase
   include Redmine::Pagination::Helper
 
   def test_per_page_options_should_return_usefull_values
-- 
1.8.4.5

From 51d899938d9afe39a9391217dce170a786f114be Mon Sep 17 00:00:00 2001
From: Toshi MARUYAMA <marutosijp2@yahoo.co.jp>
Date: Thu, 26 Dec 2013 09:19:56 +0000
Subject: [PATCH 06/18] code format cleanup Principal class

git-svn-id: http://svn.redmine.org/redmine/trunk@12464 e93f8b46-1217-0410-a6f0-8f06a7374b81
---
 app/models/principal.rb | 6 +++++-
 1 file changed, 5 insertions(+), 1 deletion(-)

diff --git a/app/models/principal.rb b/app/models/principal.rb
index b6f41d5..9cb3b1b 100644
--- a/app/models/principal.rb
+++ b/app/models/principal.rb
@@ -25,7 +25,11 @@ class Principal < ActiveRecord::Base
   STATUS_LOCKED     = 3
 
   has_many :members, :foreign_key => 'user_id', :dependent => :destroy
-  has_many :memberships, :class_name => 'Member', :foreign_key => 'user_id', :include => [ :project, :roles ], :conditions => "#{Project.table_name}.status<>#{Project::STATUS_ARCHIVED}", :order => "#{Project.table_name}.name"
+  has_many :memberships, :class_name => 'Member',
+           :foreign_key => 'user_id',
+           :include => [:project, :roles],
+           :conditions => "#{Project.table_name}.status<>#{Project::STATUS_ARCHIVED}",
+           :order => "#{Project.table_name}.name"
   has_many :projects, :through => :memberships
   has_many :issue_categories, :foreign_key => 'assigned_to_id', :dependent => :nullify
 
-- 
1.8.4.5

From 45b06255272302b249b4a51a88c2af13f3c2e525 Mon Sep 17 00:00:00 2001
From: Toshi MARUYAMA <marutosijp2@yahoo.co.jp>
Date: Thu, 26 Dec 2013 10:33:18 +0000
Subject: [PATCH 07/18] Rails4 compatibility of version group count

git-svn-id: http://svn.redmine.org/redmine/trunk@12465 e93f8b46-1217-0410-a6f0-8f06a7374b81
---
 app/models/version.rb | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/app/models/version.rb b/app/models/version.rb
index e386af5..8e5e536 100644
--- a/app/models/version.rb
+++ b/app/models/version.rb
@@ -232,7 +232,7 @@ class Version < ActiveRecord::Base
     unless @issue_count
       @open_issues_count = 0
       @closed_issues_count = 0
-      fixed_issues.count(:all, :group => :status).each do |status, count|
+      fixed_issues.group(:status).count.each do |status, count|
         if status.is_closed?
           @closed_issues_count += count
         else
-- 
1.8.4.5

From 04ab2c38d3e39ab3ecc4c4e8c2a4ab47119e2489 Mon Sep 17 00:00:00 2001
From: Toshi MARUYAMA <marutosijp2@yahoo.co.jp>
Date: Thu, 26 Dec 2013 10:45:13 +0000
Subject: [PATCH 08/18] Rails4 compatibility of ProjectTest

git-svn-id: http://svn.redmine.org/redmine/trunk@12466 e93f8b46-1217-0410-a6f0-8f06a7374b81
---
 test/unit/project_test.rb | 4 ++--
 1 file changed, 2 insertions(+), 2 deletions(-)

diff --git a/test/unit/project_test.rb b/test/unit/project_test.rb
index 88e99c4..5c79b0d 100644
--- a/test/unit/project_test.rb
+++ b/test/unit/project_test.rb
@@ -258,8 +258,8 @@ class ProjectTest < ActiveSupport::TestCase
     assert_equal 0, WikiPage.count
     assert_equal 0, WikiContent.count
     assert_equal 0, WikiContent::Version.count
-    assert_equal 0, Project.connection.select_all("SELECT * FROM projects_trackers").size
-    assert_equal 0, Project.connection.select_all("SELECT * FROM custom_fields_projects").size
+    assert_equal 0, Project.connection.select_all("SELECT * FROM projects_trackers").count
+    assert_equal 0, Project.connection.select_all("SELECT * FROM custom_fields_projects").count
     assert_equal 0, CustomValue.where(:customized_type => ['Project', 'Issue', 'TimeEntry', 'Version']).count
   end
 
-- 
1.8.4.5

From f730074248cb7f2e0e2440b7ed496cbb7594355f Mon Sep 17 00:00:00 2001
From: Toshi MARUYAMA <marutosijp2@yahoo.co.jp>
Date: Fri, 27 Dec 2013 03:25:32 +0000
Subject: [PATCH 09/18] fix find_all_by_id(n1, n2) parameter at
 test_show_export_to_pdf_with_changesets of IssuesControllerTest

find_all_by_id(n1, n2) returns only n1 result.

git-svn-id: http://svn.redmine.org/redmine/trunk@12467 e93f8b46-1217-0410-a6f0-8f06a7374b81
---
 test/functional/issues_controller_test.rb | 17 +++++++++++------
 1 file changed, 11 insertions(+), 6 deletions(-)

diff --git a/test/functional/issues_controller_test.rb b/test/functional/issues_controller_test.rb
index 6fa4253..998745f 100644
--- a/test/functional/issues_controller_test.rb
+++ b/test/functional/issues_controller_test.rb
@@ -1423,12 +1423,17 @@ class IssuesControllerTest < ActionController::TestCase
   end
 
   def test_show_export_to_pdf_with_changesets
-    Issue.find(3).changesets = Changeset.find_all_by_id(100, 101, 102)
-
-    get :show, :id => 3, :format => 'pdf'
-    assert_response :success
-    assert_equal 'application/pdf', @response.content_type
-    assert @response.body.starts_with?('%PDF')
+    [[100], [100, 101], [100, 101, 102]].each do |cs|
+      issue1 = Issue.find(3)
+      issue1.changesets = Changeset.find(cs)
+      issue1.save!
+      issue = Issue.find(3)
+      assert_equal issue.changesets.count, cs.size
+      get :show, :id => 3, :format => 'pdf'
+      assert_response :success
+      assert_equal 'application/pdf', @response.content_type
+      assert @response.body.starts_with?('%PDF')
+    end
   end
 
   def test_show_invalid_should_respond_with_404
-- 
1.8.4.5

From 0d03f2bc3d2c45029a36169ac15bbf6d45bedbe8 Mon Sep 17 00:00:00 2001
From: Toshi MARUYAMA <marutosijp2@yahoo.co.jp>
Date: Fri, 27 Dec 2013 03:25:49 +0000
Subject: [PATCH 10/18] fix find_all_by_id(n1, n2) parameter at
 test_not_member_of_scope_should_return_users_that_have_no_memberships of
 PrincipalTest

find_all_by_id(n1, n2) returns only n1 result.

git-svn-id: http://svn.redmine.org/redmine/trunk@12468 e93f8b46-1217-0410-a6f0-8f06a7374b81
---
 test/unit/principal_test.rb | 9 ++++++---
 1 file changed, 6 insertions(+), 3 deletions(-)

diff --git a/test/unit/principal_test.rb b/test/unit/principal_test.rb
index 02742b0..bbf8710 100644
--- a/test/unit/principal_test.rb
+++ b/test/unit/principal_test.rb
@@ -40,9 +40,12 @@ class PrincipalTest < ActiveSupport::TestCase
   end
 
   def test_not_member_of_scope_should_return_users_that_have_no_memberships
-    projects = Project.find_all_by_id(1, 2)
-    expected = (Principal.all - projects.map(&:memberships).flatten.map(&:principal)).sort
-    assert_equal expected, Principal.not_member_of(projects).sort
+    [[1], [1, 2]].each do |ids|
+      projects = Project.find(ids)
+      assert_equal ids.size, projects.count
+      expected = (Principal.all - projects.map(&:memberships).flatten.map(&:principal)).sort
+      assert_equal expected, Principal.not_member_of(projects).sort
+    end
   end
 
   def test_not_member_of_scope_should_be_empty_for_no_projects
-- 
1.8.4.5

From 19a0e799fae05d62d34e61822f07383128229ecd Mon Sep 17 00:00:00 2001
From: Toshi MARUYAMA <marutosijp2@yahoo.co.jp>
Date: Fri, 27 Dec 2013 03:26:05 +0000
Subject: [PATCH 11/18] fix find_all_by_id(n1, n2) parameter at
 test_member_of_scope_should_return_the_union_of_all_members of PrincipalTest

find_all_by_id(n1, n2) returns only n1 result.

git-svn-id: http://svn.redmine.org/redmine/trunk@12469 e93f8b46-1217-0410-a6f0-8f06a7374b81
---
 test/unit/principal_test.rb | 6 ++++--
 1 file changed, 4 insertions(+), 2 deletions(-)

diff --git a/test/unit/principal_test.rb b/test/unit/principal_test.rb
index bbf8710..3c8a803 100644
--- a/test/unit/principal_test.rb
+++ b/test/unit/principal_test.rb
@@ -31,8 +31,10 @@ class PrincipalTest < ActiveSupport::TestCase
   end
 
   def test_member_of_scope_should_return_the_union_of_all_members
-    projects = Project.find_all_by_id(1, 2)
-    assert_equal projects.map(&:principals).flatten.sort, Principal.member_of(projects).sort
+    projects = Project.find([1])
+    assert_equal [3, 2], Principal.member_of(projects).sort.map(&:id)
+    projects = Project.find([1, 2])
+    assert_equal [3, 2, 8, 11], Principal.member_of(projects).sort.map(&:id)
   end
 
   def test_member_of_scope_should_be_empty_for_no_projects
-- 
1.8.4.5

From d9db704b2a7e796c350959db0f11af003507b44f Mon Sep 17 00:00:00 2001
From: Toshi MARUYAMA <marutosijp2@yahoo.co.jp>
Date: Fri, 27 Dec 2013 03:40:30 +0000
Subject: [PATCH 12/18] Rails4 compatibility of RepositoryTest

git-svn-id: http://svn.redmine.org/redmine/trunk@12470 e93f8b46-1217-0410-a6f0-8f06a7374b81
---
 test/unit/repository_test.rb | 6 ++----
 1 file changed, 2 insertions(+), 4 deletions(-)

diff --git a/test/unit/repository_test.rb b/test/unit/repository_test.rb
index c269df7..2bf12f1 100644
--- a/test/unit/repository_test.rb
+++ b/test/unit/repository_test.rb
@@ -153,8 +153,7 @@ class RepositoryTest < ActiveSupport::TestCase
   def test_destroy_should_delete_parents_associations
     changeset = Changeset.find(102)
     changeset.parents = Changeset.find_all_by_id([100, 101])
-
-    assert_difference 'Changeset.connection.select_all("select * from changeset_parents").size', -2 do
+    assert_difference 'Changeset.connection.select_all("select * from changeset_parents").count', -2 do
       Repository.find(10).destroy
     end
   end
@@ -162,8 +161,7 @@ class RepositoryTest < ActiveSupport::TestCase
   def test_destroy_should_delete_issues_associations
     changeset = Changeset.find(102)
     changeset.issues = Issue.find_all_by_id([1, 2])
-
-    assert_difference 'Changeset.connection.select_all("select * from changesets_issues").size', -2 do
+    assert_difference 'Changeset.connection.select_all("select * from changesets_issues").count', -2 do
       Repository.find(10).destroy
     end
   end
-- 
1.8.4.5

From f758a574d3924a755f32dd18b3e3431841506450 Mon Sep 17 00:00:00 2001
From: Toshi MARUYAMA <marutosijp2@yahoo.co.jp>
Date: Fri, 27 Dec 2013 23:33:15 +0000
Subject: [PATCH 13/18] explicitly define fix has_and_belongs_to_many
 join_table at Group and User

Rails4 cannot resolve automatically.

git-svn-id: http://svn.redmine.org/redmine/trunk@12471 e93f8b46-1217-0410-a6f0-8f06a7374b81
---
 app/models/group.rb | 6 ++++--
 app/models/user.rb  | 6 ++++--
 2 files changed, 8 insertions(+), 4 deletions(-)

diff --git a/app/models/group.rb b/app/models/group.rb
index d1b2cb9..3e4bdf0 100644
--- a/app/models/group.rb
+++ b/app/models/group.rb
@@ -18,8 +18,10 @@
 class Group < Principal
   include Redmine::SafeAttributes
 
-  has_and_belongs_to_many :users, :after_add => :user_added,
-                                  :after_remove => :user_removed
+  has_and_belongs_to_many :users,
+                          :join_table   => "#{table_name_prefix}groups_users#{table_name_suffix}",
+                          :after_add => :user_added,
+                          :after_remove => :user_removed
 
   acts_as_customizable
 
diff --git a/app/models/user.rb b/app/models/user.rb
index 9020295..74528aa 100644
--- a/app/models/user.rb
+++ b/app/models/user.rb
@@ -68,8 +68,10 @@ class User < Principal
     ['none', :label_user_mail_option_none]
   ]
 
-  has_and_belongs_to_many :groups, :after_add => Proc.new {|user, group| group.user_added(user)},
-                                   :after_remove => Proc.new {|user, group| group.user_removed(user)}
+  has_and_belongs_to_many :groups,
+                          :join_table   => "#{table_name_prefix}groups_users#{table_name_suffix}",
+                          :after_add    => Proc.new {|user, group| group.user_added(user)},
+                          :after_remove => Proc.new {|user, group| group.user_removed(user)}
   has_many :changesets, :dependent => :nullify
   has_one :preference, :dependent => :destroy, :class_name => 'UserPreference'
   has_one :rss_token, :class_name => 'Token', :conditions => "action='feeds'"
-- 
1.8.4.5

From 861fd4df9e5c17b6a0726c740f5026de2ccfb054 Mon Sep 17 00:00:00 2001
From: Toshi MARUYAMA <marutosijp2@yahoo.co.jp>
Date: Sun, 29 Dec 2013 13:48:52 +0000
Subject: [PATCH 14/18] Rails4: scm: reload repository after destroying
 changesets in incremental fetch test

git-svn-id: http://svn.redmine.org/redmine/trunk@12472 e93f8b46-1217-0410-a6f0-8f06a7374b81
---
 test/unit/repository_bazaar_test.rb     | 1 +
 test/unit/repository_cvs_test.rb        | 1 +
 test/unit/repository_darcs_test.rb      | 1 +
 test/unit/repository_mercurial_test.rb  | 1 +
 test/unit/repository_subversion_test.rb | 1 +
 5 files changed, 5 insertions(+)

diff --git a/test/unit/repository_bazaar_test.rb b/test/unit/repository_bazaar_test.rb
index 118820d..fe8e3b0 100644
--- a/test/unit/repository_bazaar_test.rb
+++ b/test/unit/repository_bazaar_test.rb
@@ -107,6 +107,7 @@ class RepositoryBazaarTest < ActiveSupport::TestCase
       # Remove changesets with revision > 5
       @repository.changesets.all.each {|c| c.destroy if c.revision.to_i > 2}
       @project.reload
+      @repository.reload
       assert_equal 2, @repository.changesets.count
 
       @repository.fetch_changesets
diff --git a/test/unit/repository_cvs_test.rb b/test/unit/repository_cvs_test.rb
index faa948b..d21aad6 100644
--- a/test/unit/repository_cvs_test.rb
+++ b/test/unit/repository_cvs_test.rb
@@ -118,6 +118,7 @@ class RepositoryCvsTest < ActiveSupport::TestCase
       # Remove changesets with revision > 3
       @repository.changesets.all.each {|c| c.destroy if c.revision.to_i > 3}
       @project.reload
+      @repository.reload
       assert_equal 3, @repository.changesets.count
       assert_equal %w|3 2 1|, @repository.changesets.all.collect(&:revision)
 
diff --git a/test/unit/repository_darcs_test.rb b/test/unit/repository_darcs_test.rb
index 5e51dcc..7a7b402 100644
--- a/test/unit/repository_darcs_test.rb
+++ b/test/unit/repository_darcs_test.rb
@@ -81,6 +81,7 @@ class RepositoryDarcsTest < ActiveSupport::TestCase
       # Remove changesets with revision > 3
       @repository.changesets.all.each {|c| c.destroy if c.revision.to_i > 3}
       @project.reload
+      @repository.reload
       assert_equal 3, @repository.changesets.count
 
       @repository.fetch_changesets
diff --git a/test/unit/repository_mercurial_test.rb b/test/unit/repository_mercurial_test.rb
index 83b67bc..207528b 100644
--- a/test/unit/repository_mercurial_test.rb
+++ b/test/unit/repository_mercurial_test.rb
@@ -104,6 +104,7 @@ class RepositoryMercurialTest < ActiveSupport::TestCase
       # Remove changesets with revision > 2
       @repository.changesets.all.each {|c| c.destroy if c.revision.to_i > 2}
       @project.reload
+      @repository.reload
       assert_equal 3, @repository.changesets.count
 
       @repository.fetch_changesets
diff --git a/test/unit/repository_subversion_test.rb b/test/unit/repository_subversion_test.rb
index df5455d..45eff11 100644
--- a/test/unit/repository_subversion_test.rb
+++ b/test/unit/repository_subversion_test.rb
@@ -77,6 +77,7 @@ class RepositorySubversionTest < ActiveSupport::TestCase
       # Remove changesets with revision > 5
       @repository.changesets.all.each {|c| c.destroy if c.revision.to_i > 5}
       @project.reload
+      @repository.reload
       assert_equal 5, @repository.changesets.count
 
       @repository.fetch_changesets
-- 
1.8.4.5

From 91cb86417ccb0bae466a2fd6d39695c70e577088 Mon Sep 17 00:00:00 2001
From: Toshi MARUYAMA <marutosijp2@yahoo.co.jp>
Date: Sun, 29 Dec 2013 13:49:09 +0000
Subject: [PATCH 15/18] Rails4: replace deprecated find_by_id at Changeset
 class

git-svn-id: http://svn.redmine.org/redmine/trunk@12473 e93f8b46-1217-0410-a6f0-8f06a7374b81
---
 app/models/changeset.rb | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/app/models/changeset.rb b/app/models/changeset.rb
index ff210e9..3659811 100644
--- a/app/models/changeset.rb
+++ b/app/models/changeset.rb
@@ -197,7 +197,7 @@ class Changeset < ActiveRecord::Base
   # Finds an issue that can be referenced by the commit message
   def find_referenced_issue_by_id(id)
     return nil if id.blank?
-    issue = Issue.find_by_id(id.to_i, :include => :project)
+    issue = Issue.includes(:project).where(:id => id.to_i).first
     if Setting.commit_cross_project_ref?
       # all issues can be referenced/fixed
     elsif issue
-- 
1.8.4.5

From 7ce3656516c0b55668ab857a4ee62b2a428987fc Mon Sep 17 00:00:00 2001
From: Toshi MARUYAMA <marutosijp2@gmail.com>
Date: Fri, 20 Dec 2013 22:58:50 +0900
Subject: [PATCH 16/18] Rails4: TODO: 10-patches.rb: comment out
 ActionView::Helpers::InstanceTag

<pre>
undefined method `add_options' for class `ActionView::Helpers::InstanceTag'
/home/xxxx/.rvm/gems/ruby-1.9.3-p484/gems/activesupport-4.0.2/lib/active_support/core_ext/module/aliasing.rb:32:in `alias_method'
/home/xxxx/.rvm/gems/ruby-1.9.3-p484/gems/activesupport-4.0.2/lib/active_support/core_ext/module/aliasing.rb:32:in `alias_method_chain'
/REDMINE/hg-workdir/MY-WORK/bb-rails4/config/initializers/10-patches.rb:106:in `<class:InstanceTag>'
/REDMINE/hg-workdir/MY-WORK/bb-rails4/config/initializers/10-patches.rb:97:in `<module:Helpers>'
/REDMINE/hg-workdir/MY-WORK/bb-rails4/config/initializers/10-patches.rb:96:in `<module:ActionView>'
/REDMINE/hg-workdir/MY-WORK/bb-rails4/config/initializers/10-patches.rb:95:in `<top (required)>'

</pre>

--HG--
branch : rails4.20131226
extra : source : b577b1f78ea402fccab54591bcbe7356cbb3d0a4
---
 config/initializers/10-patches.rb | 2 ++
 1 file changed, 2 insertions(+)

diff --git a/config/initializers/10-patches.rb b/config/initializers/10-patches.rb
index d186bcd..ee05e99 100644
--- a/config/initializers/10-patches.rb
+++ b/config/initializers/10-patches.rb
@@ -92,6 +92,7 @@ end
 ActionView::Base.field_error_proc = Proc.new{ |html_tag, instance| html_tag || ''.html_safe }
 
 # HTML5: <option value=""></option> is invalid, use <option value="">&nbsp;</option> instead
+if false
 module ActionView
   module Helpers
     class InstanceTag
@@ -127,6 +128,7 @@ module ActionView
     end
   end
 end
+end
 
 require 'mail'
 
-- 
1.8.4.5

From c56c823c1eef7b07ab80761bce0cb0c6e72e0fdd Mon Sep 17 00:00:00 2001
From: Toshi MARUYAMA <marutosijp2@gmail.com>
Date: Sun, 22 Dec 2013 16:53:52 +0900
Subject: [PATCH 17/18] Rails4: TODO: 10-patches.rb: comment out
 ActionView::Helpers::InstanceTag

<pre>
ActionView::Template::Error (undefined method `encoding_aware?' for #<String:0x000000038d3580>):
  config/initializers/10-patches.rb:63:in `call'
</pre>

--HG--
branch : rails4.20131226
extra : source : 30d3b85c0707bc56b96b66cd2f067e7344df4074
---
 config/initializers/10-patches.rb | 2 ++
 1 file changed, 2 insertions(+)

diff --git a/config/initializers/10-patches.rb b/config/initializers/10-patches.rb
index ee05e99..92f3681 100644
--- a/config/initializers/10-patches.rb
+++ b/config/initializers/10-patches.rb
@@ -55,6 +55,7 @@ module ActionView
 end
 
 # Do not HTML escape text templates
+if false
 module ActionView
   class Template
     module Handlers
@@ -88,6 +89,7 @@ module ActionView
     end
   end
 end
+end
 
 ActionView::Base.field_error_proc = Proc.new{ |html_tag, instance| html_tag || ''.html_safe }
 
-- 
1.8.4.5

From 07963de0e5c58c6d6384afda6ae0b7684cb399d6 Mon Sep 17 00:00:00 2001
From: Toshi MARUYAMA <marutosijp2@gmail.com>
Date: Thu, 26 Dec 2013 18:24:32 +0900
Subject: [PATCH 18/18] Rails4: TODO: model: Principal has_many :memberships

--HG--
branch : rails4.20131226
extra : source : 1e608e8a24852fc203268c7b1a9098fcbfbf880d
---
 app/models/principal.rb | 13 ++++++++-----
 1 file changed, 8 insertions(+), 5 deletions(-)

diff --git a/app/models/principal.rb b/app/models/principal.rb
index 9cb3b1b..8c6f4e1 100644
--- a/app/models/principal.rb
+++ b/app/models/principal.rb
@@ -26,11 +26,14 @@ class Principal < ActiveRecord::Base
 
   has_many :members, :foreign_key => 'user_id', :dependent => :destroy
   has_many :memberships, :class_name => 'Member',
-           :foreign_key => 'user_id',
-           :include => [:project, :roles],
-           :conditions => "#{Project.table_name}.status<>#{Project::STATUS_ARCHIVED}",
-           :order => "#{Project.table_name}.name"
-  has_many :projects, :through => :memberships
+           :foreign_key => 'user_id'
+           # :conditions => "#{Project.table_name}.status<>#{Project::STATUS_ARCHIVED}",
+           # :order => "#{Project.table_name}.name"
+           # -> {includes([:project, :role])}
+  # has_many :projects, :through => :memberships
+  has_many :projects, :through => :memberships,
+           :conditions => "status <> #{Project::STATUS_ARCHIVED}",
+           :order => "name"
   has_many :issue_categories, :foreign_key => 'assigned_to_id', :dependent => :nullify
 
   # Groups and active users
-- 
1.8.4.5

